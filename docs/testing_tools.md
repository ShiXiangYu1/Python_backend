# 测试工具使用指南

本文档详细介绍了项目中各种测试工具的使用方法、功能和示例输出，帮助开发者选择适合的工具进行项目验证和测试。

## 1. 组件验证工具

### 简介

组件验证工具用于检查项目的核心组件是否正常，包括依赖检查、配置验证、数据库配置、模型验证等。这是一个轻量级工具，不需要启动服务器即可运行。

### 使用方法

```bash
python scripts/verify_components.py
```

### 功能

- **依赖检查**：验证所有必要的依赖包是否已安装
- **配置模块加载**：验证核心配置模块是否可以正确加载
- **数据库模块配置**：检查数据库连接配置是否正确
- **模型类定义**：验证数据模型类是否正确定义
- **环境变量完整性**：检查必要的环境变量是否设置

### 示例输出

```
[2025-04-05 10:15:32] INFO: 开始验证项目组件...
[2025-04-05 10:15:32] INFO: 检查依赖包...
[2025-04-05 10:15:32] INFO: 依赖包检查完成: 所有必要依赖已安装
[2025-04-05 10:15:33] INFO: 验证配置模块...
[2025-04-05 10:15:33] INFO: 配置模块加载成功
[2025-04-05 10:15:33] INFO: 检查环境变量...
[2025-04-05 10:15:33] INFO: 环境变量检查完成: 所有必要变量已设置
[2025-04-05 10:15:33] INFO: 验证数据库配置...
[2025-04-05 10:15:33] INFO: 数据库配置验证成功
[2025-04-05 10:15:34] INFO: 验证模型定义...
[2025-04-05 10:15:34] INFO: 模型定义验证成功
[2025-04-05 10:15:34] INFO: 验证应用加载...
[2025-04-05 10:15:34] INFO: 应用加载成功
[2025-04-05 10:15:34] INFO: 组件验证完成: 所有组件正常
```

## 2. 简化版集成测试

### 简介

简化版集成测试是一个静态验证工具，用于验证项目的结构和设计，而无需启动服务器或依赖第三方库。

### 使用方法

```bash
python scripts/simple_integration_test.py
```

### 功能

- **文件结构验证**：验证项目的目录结构是否符合预期
- **API定义分析**：检查API路由和端点定义
- **模型/Schema验证**：验证数据模型和Schema定义
- **配置文件验证**：检查配置文件的完整性
- **服务层分析**：分析服务层实现是否完整
- **测试套件检查**：验证测试套件的覆盖情况

### 示例输出

```
[2025-04-05 10:20:45] INFO: 开始执行简化集成测试...
[2025-04-05 10:20:45] INFO: 分析API定义...
[2025-04-05 10:20:45] INFO: 验证模型和Schema...
[2025-04-05 10:20:45] INFO: 检查配置文件...
[2025-04-05 10:20:46] INFO: 分析服务层实现...
[2025-04-05 10:20:46] INFO: 检查测试套件...
[2025-04-05 10:20:46] INFO: 集成测试完成。

==== 集成测试报告 ====
测试时间: 2025-04-05 10:20:46
总计得分: 6/6 (100.0%)

=== 详细结果 ===
✅ 文件结构: 通过
   - 所有必要的目录和文件都存在
   - 未发现缺少的关键文件

✅ API定义: 通过
   - 发现路由文件: 6个
   - 发现端点: 24个
   - 基础端点覆盖: 健康检查、认证、用户管理、模型管理、API密钥管理

✅ 模型/Schema: 通过
   - 发现模型: 5个
   - 发现Schema: 15个
   - 所有核心实体都有对应模型和Schema

✅ 配置文件: 通过
   - 发现配置文件
   - 环境变量文件存在
   - 所有必需的设置项都已配置

✅ 服务层: 通过
   - 服务层实现完整
   - 所有核心功能都有服务层实现

✅ 测试套件: 通过
   - 测试文件: 10个
   - API测试和单元测试都已实现
   - 测试覆盖主要功能模块
```

## 3. 性能测试工具

### 简介

性能测试工具用于评估API的响应时间和吞吐量，使用纯Python标准库实现，不依赖第三方库。

### 使用方法

```bash
python scripts/performance_test.py [--host HOSTNAME] [--port PORT] [--concurrency CONCURRENCY] [--requests REQUESTS] [--timeout TIMEOUT] [--output OUTPUT_FILE]
```

**参数说明：**
- `--host`: 服务器主机名（默认: localhost）
- `--port`: 服务器端口（默认: 8000）
- `--concurrency`: 并发连接数（默认: 10）
- `--requests`: 每个端点测试的请求数（默认: 100）
- `--timeout`: 请求超时时间，秒（默认: 10）
- `--output`: 结果输出文件（默认: performance_results.json）

### 功能

- **并发测试**：支持多个并发连接测试API性能
- **多端点测试**：自动检测并测试多个API端点
- **响应时间统计**：记录最小、最大、平均响应时间
- **吞吐量计算**：计算每秒可处理的请求数
- **性能报告生成**：生成详细的性能测试报告

### 示例输出

```
[2025-04-05 11:05:22] INFO: 开始性能测试...
[2025-04-05 11:05:22] INFO: 主机: localhost, 端口: 8000, 并发: 10, 请求数: 100
[2025-04-05 11:05:22] INFO: 探测可用端点...
[2025-04-05 11:05:23] INFO: 发现7个端点可用于测试
[2025-04-05 11:05:23] INFO: 开始测试端点: /api/v1/health
[2025-04-05 11:05:25] INFO: 完成端点 /api/v1/health: 100/100 请求
[2025-04-05 11:05:25] INFO: 开始测试端点: /api/v1/users/me
[2025-04-05 11:05:28] INFO: 完成端点 /api/v1/users/me: 100/100 请求
...
[2025-04-05 11:06:12] INFO: 所有端点测试完成
[2025-04-05 11:06:12] INFO: 生成性能报告...
[2025-04-05 11:06:12] INFO: 性能报告已保存至: performance_results.json

==== 性能测试总结 ====
测试时间: 2025-04-05 11:06:12
测试持续时间: 50.23秒
测试端点总数: 7
总请求数: 700

最快端点: /api/v1/health (55.2ms 平均响应时间)
最慢端点: /api/v1/models/upload (428.6ms 平均响应时间)
平均响应时间: 142.8ms
总吞吐量: 13.9 请求/秒
```

## 4. 安全扫描工具

### 简介

安全扫描工具用于检查项目中常见的安全问题，如硬编码密钥、不安全的配置等。

### 使用方法

```bash
python scripts/security_scan.py [--output OUTPUT_FILE] [--exclude EXCLUDE_DIRS]
```

**参数说明：**
- `--output`: 扫描结果输出文件（默认: security_report.json）
- `--exclude`: 要排除的目录，逗号分隔（默认: .git,venv,__pycache__,alembic）

### 功能

- **硬编码密钥检查**：检测代码中的硬编码API密钥、密码
- **不安全配置检查**：识别不安全的应用配置
- **潜在安全漏洞检测**：检测可能导致安全漏洞的代码模式
- **安全最佳实践违反检查**：检查是否违反安全最佳实践
- **安全报告生成**：生成详细的安全扫描报告

### 示例输出

```
[2025-04-05 11:30:15] INFO: 开始安全扫描...
[2025-04-05 11:30:15] INFO: 排除目录: .git,venv,__pycache__,alembic
[2025-04-05 11:30:15] INFO: 扫描文件: app/core/config.py
[2025-04-05 11:30:15] INFO: 扫描文件: app/api/auth.py
...
[2025-04-05 11:30:45] INFO: 扫描完成，共检查152个文件
[2025-04-05 11:30:45] INFO: 发现3个安全问题
[2025-04-05 11:30:45] INFO: 生成安全报告...
[2025-04-05 11:30:45] INFO: 安全报告已保存至: security_report.json

==== 安全扫描总结 ====
扫描时间: 2025-04-05 11:30:45
扫描文件数: 152
发现问题总数: 3

按严重程度分类:
- 高: 1
- 中: 1
- 低: 1
- 信息: 0

问题类型:
- 硬编码密钥: 1
- 不安全导入: 1
- 缺少安全保护: 1

建议:
1. 审查发现的硬编码密钥，移至环境变量或安全存储
2. 检查不安全导入，特别是 pickle 模块的使用
3. 确保所有API端点都有适当的访问控制
```

## 5. 完整集成测试

### 简介

完整集成测试用于端到端测试API的功能，需要服务器正在运行。

### 使用方法

```bash
python scripts/integration_test.py
```

### 功能

- **依赖和服务可用性检查**：检查所需依赖和服务是否可用
- **用户认证测试**：测试用户注册和登录流程
- **模型管理测试**：测试模型上传、查询和删除功能
- **API密钥管理测试**：测试API密钥创建和验证
- **健康检查测试**：测试API健康状态端点

### 示例输出

```
[2025-04-05 12:00:22] INFO: 开始集成测试...
[2025-04-05 12:00:22] INFO: 检查依赖...
[2025-04-05 12:00:22] INFO: 所有依赖已安装
[2025-04-05 12:00:22] INFO: 检查服务可用性...
[2025-04-05 12:00:22] INFO: 服务可用，继续测试
[2025-04-05 12:00:22] INFO: 测试用户认证...
[2025-04-05 12:00:23] INFO: 用户注册成功
[2025-04-05 12:00:23] INFO: 用户登录成功
[2025-04-05 12:00:23] INFO: 测试模型管理...
[2025-04-05 12:00:24] INFO: 模型上传成功
[2025-04-05 12:00:24] INFO: 模型查询成功
[2025-04-05 12:00:24] INFO: 模型删除成功
[2025-04-05 12:00:24] INFO: 测试API密钥管理...
[2025-04-05 12:00:25] INFO: API密钥创建成功
[2025-04-05 12:00:25] INFO: API密钥验证成功
[2025-04-05 12:00:25] INFO: 测试健康检查...
[2025-04-05 12:00:25] INFO: 健康检查响应正常
[2025-04-05 12:00:25] INFO: 集成测试全部通过!

==== 集成测试报告 ====
测试时间: 2025-04-05 12:00:25
通过测试: 4/4
成功率: 100%

测试详情:
✅ 用户认证测试: 通过
✅ 模型管理测试: 通过
✅ API密钥管理测试: 通过
✅ 健康检查测试: 通过
```

## 如何选择适合的测试工具

根据不同的使用场景，可以选择不同的测试工具：

1. **初始环境检查**: 使用组件验证工具 (`verify_components.py`)
2. **无依赖项目结构验证**: 使用简化版集成测试 (`simple_integration_test.py`)
3. **性能评估**: 使用性能测试工具 (`performance_test.py`)
4. **安全审计**: 使用安全扫描工具 (`security_scan.py`)
5. **功能验证**: 使用完整集成测试 (`integration_test.py`)，但需要确保服务器正在运行

## 持续集成环境中的使用

在CI/CD流程中使用这些测试工具的最佳实践：

1. **构建前检查**: 在构建前运行组件验证工具和简化版集成测试
2. **构建后测试**: 构建完成后运行完整集成测试
3. **定期安全扫描**: 定期运行安全扫描工具，特别是在合并重要变更后
4. **性能回归测试**: 在重要版本发布前运行性能测试工具，与历史数据比较确保性能未下降

示例CI流程：

```yaml
stages:
  - pre-build
  - build
  - test
  - security
  - performance
  - deploy

pre-build:
  script:
    - python scripts/verify_components.py
    - python scripts/simple_integration_test.py

build:
  script:
    - docker build -t ai-model-platform:latest .

test:
  script:
    - docker-compose up -d
    - sleep 10  # 等待服务启动
    - python scripts/integration_test.py
    - docker-compose down

security:
  script:
    - python scripts/security_scan.py

performance:
  script:
    - docker-compose up -d
    - sleep 10  # 等待服务启动
    - python scripts/performance_test.py
    - docker-compose down

deploy:
  script:
    - ./scripts/docker-deploy.sh
  only:
    - main
``` 