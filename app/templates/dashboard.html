{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <h2 class="card-title">欢迎回来, <span id="userName">用户</span>!</h2>
                <p class="card-text">这是您的AI模型管理控制台，管理和部署您的模型。</p>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card text-white bg-primary shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase">模型总数</h6>
                        <h2 class="mb-0" id="totalModels">0</h2>
                    </div>
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 16V8C21 7.45 20.8 6.979 20.4 6.587C20 6.196 19.55 6 19 6L13 2L7 6C6.45 6 6 6.196 5.6 6.587C5.2 6.979 5 7.45 5 8V16C5 16.55 5.2 17.021 5.6 17.413C6 17.804 6.45 18 7 18L13 22L19 18C19.55 18 20 17.804 20.4 17.413C20.8 17.021 21 16.55 21 16Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill-opacity="0.2" fill="white"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card text-white bg-success shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase">已部署模型</h6>
                        <h2 class="mb-0" id="deployedModels">0</h2>
                    </div>
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M5 12H19" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 5L19 12L12 19" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card text-white bg-info shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase">API密钥</h6>
                        <h2 class="mb-0" id="totalApiKeys">0</h2>
                    </div>
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 7.5V7C15 4.794 13.206 3 11 3C8.794 3 7 4.794 7 7V7.5C5.067 8.732 4 10.786 4 13C4 16.866 7.134 20 11 20C14.866 20 18 16.866 18 13C18 10.786 16.933 8.732 15 7.5Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M10 13L12 15L16 11" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card text-white bg-warning shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase">API调用次数</h6>
                        <h2 class="mb-0" id="totalApiCalls">0</h2>
                    </div>
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 12C21 13.1819 20.7672 14.3522 20.3149 15.4442C19.8626 16.5361 19.1997 17.5282 18.364 18.364C17.5282 19.1997 16.5361 19.8626 15.4442 20.3149C14.3522 20.7672 13.1819 21 12 21C10.8181 21 9.64778 20.7672 8.55585 20.3149C7.46392 19.8626 6.47177 19.1997 5.63604 18.364C4.80031 17.5282 4.13738 16.5361 3.68508 15.4442C3.23279 14.3522 3 13.1819 3 12C3 9.61305 3.94821 7.32387 5.63604 5.63604C7.32387 3.94821 9.61305 3 12 3C14.3869 3 16.6761 3.94821 18.364 5.63604C20.0518 7.32387 21 9.61305 21 12Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 6V12L16 14" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8 mb-4">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">最近模型</h5>
                <a href="/models" class="btn btn-sm btn-primary">查看全部</a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>状态</th>
                                <th>框架</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="recentModels">
                            <tr>
                                <td colspan="5" class="text-center">正在加载数据...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">API密钥</h5>
                <a href="/api-keys" class="btn btn-sm btn-primary">管理密钥</a>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush" id="apiKeysList">
                    <li class="list-group-item text-center">正在加载数据...</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', async function() {
        // 检查是否登录
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        // 设置请求头
        axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
        
        try {
            // 加载用户信息
            const userResponse = await axios.get('/api/v1/users/me');
            document.getElementById('userName').textContent = userResponse.data.username;
            
            // 加载统计数据
            const [modelsResponse, apiKeysResponse] = await Promise.all([
                axios.get('/api/v1/models?page=1&page_size=5'),
                axios.get('/api/v1/api-keys?page=1&page_size=3')
            ]);
            
            // 更新统计卡片
            document.getElementById('totalModels').textContent = modelsResponse.data.total || 0;
            const deployedModels = modelsResponse.data.items.filter(model => model.status === 'deployed').length;
            document.getElementById('deployedModels').textContent = deployedModels;
            document.getElementById('totalApiKeys').textContent = apiKeysResponse.data.total || 0;
            document.getElementById('totalApiCalls').textContent = Math.floor(Math.random() * 1000); // 模拟数据
            
            // 渲染最近模型列表
            const recentModelsTable = document.getElementById('recentModels');
            if (modelsResponse.data.items.length > 0) {
                let modelRows = '';
                modelsResponse.data.items.forEach(model => {
                    const created = new Date(model.created_at).toLocaleString();
                    modelRows += `
                        <tr>
                            <td>${model.name}</td>
                            <td><span class="badge bg-${getStatusBadge(model.status)}">${getStatusText(model.status)}</span></td>
                            <td>${model.framework}</td>
                            <td>${created}</td>
                            <td>
                                <a href="/models/${model.id}" class="btn btn-sm btn-outline-primary">查看</a>
                            </td>
                        </tr>
                    `;
                });
                recentModelsTable.innerHTML = modelRows;
            } else {
                recentModelsTable.innerHTML = '<tr><td colspan="5" class="text-center">暂无模型数据</td></tr>';
            }
            
            // 渲染API密钥列表
            const apiKeysList = document.getElementById('apiKeysList');
            if (apiKeysResponse.data.items.length > 0) {
                let keyItems = '';
                apiKeysResponse.data.items.forEach(key => {
                    const lastUsed = key.last_used_at ? new Date(key.last_used_at).toLocaleString() : '从未使用';
                    keyItems += `
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0">${key.name}</h6>
                                    <small class="text-muted">最后使用: ${lastUsed}</small>
                                </div>
                                <span class="badge bg-${key.is_active ? 'success' : 'danger'} rounded-pill">
                                    ${key.is_active ? '激活' : '停用'}
                                </span>
                            </div>
                        </li>
                    `;
                });
                apiKeysList.innerHTML = keyItems;
            } else {
                apiKeysList.innerHTML = '<li class="list-group-item text-center">暂无API密钥</li>';
            }
            
        } catch (error) {
            console.error('加载数据失败:', error);
            if (error.response && error.response.status === 401) {
                // 未授权，跳转到登录页面
                localStorage.removeItem('access_token');
                window.location.href = '/login';
            }
        }
    });
    
    // 获取状态对应的徽章颜色
    function getStatusBadge(status) {
        switch(status) {
            case 'uploaded': return 'success';
            case 'uploading': return 'warning';
            case 'deployed': return 'primary';
            case 'failed': return 'danger';
            default: return 'secondary';
        }
    }
    
    // 获取状态对应的中文文本
    function getStatusText(status) {
        switch(status) {
            case 'uploaded': return '已上传';
            case 'uploading': return '上传中';
            case 'deployed': return '已部署';
            case 'failed': return '失败';
            default: return '未知';
        }
    }
</script>
{% endblock %} 